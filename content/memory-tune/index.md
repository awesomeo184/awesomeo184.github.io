---  
emoji: üìù  
title: 'ÏÑúÎ≤Ñ Î©îÎ™®Î¶¨ Î∂ÄÏ°± Î¨∏Ï†ú Ìï¥Í≤∞Í∏∞'   
date: '2022-11-20 23:00:00'  
author: Ïñ¥Ïç∏Ïò§  
tags: JVM OOME
categories: projects
--- 

Ïö∞ÌÖåÏΩî ÌîÑÎ°úÏ†ùÌä∏ Ï†úÏïΩÏÉÅ S3Í∞ôÏùÄ Ïä§ÌÜ†Î¶¨ÏßÄ ÏÑúÎπÑÏä§Î•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏñ¥ ÏßÅÏ†ë EC2Ïóê Ïù¥ÎØ∏ÏßÄ Ïä§ÌÜ†Î¶¨ÏßÄ ÏÑúÎ≤ÑÎ•º Íµ¨Ï∂ïÌï¥ ÏÑúÎπÑÏä§Î•º Ïö¥ÏòÅÌïòÍ≥† ÏûàÏóàÏäµÎãàÎã§.

ÏïÑÎûò Ïù∏ÌîÑÎùº Íµ¨Ï°∞ÏóêÏÑú Î≥º Ïàò ÏûàÎìØÏù¥ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑú Ïù¥ÎØ∏ÏßÄ ÏÑúÎ≤ÑÎ°ú Ïù¥ÎØ∏ÏßÄ Ï°∞ÌöåÎ•º ÏöîÏ≤≠ÌïòÎèÑÎ°ù ÏÑ§Í≥ÑÌïòÏòÄÏäµÎãàÎã§.

![server_arch](server_arch.png)

<br>

Í∑∏Îü∞Îç∞ Ïù¥ÎØ∏ÏßÄ Ï°∞ÌöåÏóê ÎåÄÌïú Î∂ÄÌïòÌÖåÏä§Ìä∏ Ï§ë, ÌÖåÏä§Ìä∏Î•º ÏãúÏûëÌïòÏûêÎßàÏûê ÏóÑÏ≤≠ÎÇú ÏóêÎü¨Í∞Ä ÏèüÏïÑÏßÄÎäî Í≤ÉÏùÑ ÌôïÏù∏ÌñàÏäµÎãàÎã§. ÏÇ¨Ïö©ÏûêÍ∞Ä Ï†ÅÎã§Î≥¥Îãà Ïö¥ÏòÅÏóêÏÑúÎäî ÎØ∏Ï≤ò Î∞úÍ≤¨ÌïòÏßÄ Î™ªÌïú Î¨∏Ï†úÏòÄÏäµÎãàÎã§.

// ÏµúÎåÄ ÌûôÌÅ¨Í∏∞ 64MBÏùº Îïå Ïù∏Ïä§ÌéôÌÑ∞ ÏÇ¨ÏßÑ
![full_gc](full_gc.png)

![heap_space_error](heap_space_error.png)

ÏúÑ ÏÇ¨ÏßÑÏóêÏÑú ÌôïÏù∏Ìï† Ïàò ÏûàÎìØÏù¥ ÌÖåÏä§Ìä∏Í∞Ä ÏãúÏûëÎêòÏûêÎßàÏûê Full GCÍ∞Ä ÎπÑÏ†ïÏÉÅÏ†ÅÏúºÎ°ú Î∞úÏÉùÌïòÍ≥†, Ìûô Í≥µÍ∞Ñ Î∂ÄÏ°±ÏúºÎ°ú Ïù∏Ìïú OutOfMemoryErrorÍ∞Ä Î∞úÏÉùÌïòÍ≥† ÏûàÏóàÏäµÎãàÎã§.

Ïù¥ÎØ∏ÏßÄ ÏÑúÎ≤ÑÎäî t4.microÎ•º ÏÇ¨Ïö©ÌïòÍ≥† ÏûàÏóàÍ≥† Î©îÎ™®Î¶¨ ÌÅ¨Í∏∞Îäî 1GB ÏòÄÏäµÎãàÎã§. ÏµúÎåÄ Ìûô ÌÅ¨Í∏∞ ÏÑ§Ï†ïÏùÑ Îî∞Î°ú Ìï¥Ï£ºÏßÄ ÏïäÏïòÍ∏∞ ÎïåÎ¨∏Ïóê Í∏∞Î≥∏ Í∞íÏùÑ ÏÇ¨Ïö©ÌïòÍ≥† ÏûàÏóàÎäîÎç∞ ÌôïÏù∏Ìï¥Î≥¥Îãà 64MBÏòÄÏäµÎãàÎã§.


Îã®ÏàúÌûà ÏµúÎåÄ Ìûô ÌÅ¨Í∏∞Î•º ÎäòÎ¶¨Î©¥ Ìï¥Í≤∞ÎêòÍ≤†ÏßÄ ÏÉùÍ∞ÅÌïòÍ≥† ÏµúÎåÄ Ìûô ÌÅ¨Í∏∞Î•º 256MBÎ°ú Ïò¨Î†∏ÏäµÎãàÎã§.
256MBÏù∏ Ïù¥Ïú† - ÏÇ¨Ïö©Ïûê Ïù¥Ïö© Ìå®ÌÑ¥, Î†àÏù¥ÏßÄ Î°úÎìúÎùº Ìïú Î≤à Ï†ëÏÜçÌï† ÎñÑ Ïù¥ÎØ∏ÏßÄ 3Í∞úÎ•º ÎÑòÏßÄ ÏïäÏùå

Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò ÎùÑÏö∞Í≥† topÏúºÎ°ú ÌòÑÏû¨ Î©îÎ™®Î¶¨ ÏÉÅÌÉú ÏÇ¥Ìé¥Î≥¥Îãà 600Ï†ïÎèÑ ÎÇ®Ïùå. Ï†àÎ∞ò Ï†ïÎèÑ Ìï†ÎãπÌïòÎ©¥ Îê†Í±∞ÎùºÍ≥† ÏÉùÍ∞Å
// top Ïù¥ÎØ∏ÏßÄ

ÌòπÏãú Î™∞Îùº Ïä§Ïôë Î©îÎ™®Î¶¨ ÎäòÎ¶º

256ÏúºÎ°ú ÎäòÎ¶¨Í≥† ÌÖåÏä§Ìä∏ ÎèåÎ†∏ÎçîÎãà ÏïÑÏßÅÎèÑ OOME

![full_gc](full_gc.png)

![heap_space_error](heap_space_error.png)


Ïù¥ÎØ∏ÏßÄÎäî Í±∞Ïùò Î≥ÄÌïòÏßÄ ÏïäÍ≥†, Ï°∞ÌöåÍ∞Ä ÎßéÏùå. Ï∫êÏãúÎ°ú Ïù¥ Î∂ÄÎ∂ÑÏùÑ Ìï¥Í≤∞ÌïòÍ≥† ÏûàÏùå. Ï¶â WASÎ°ú Ïù¥ÎØ∏ÏßÄ Ï°∞Ìöå ÏöîÏ≤≠Ïù¥ Î™∞Î¶¨Îäî Í≤ΩÏö∞Îäî Ïûò Î∞úÏÉùÌïòÏßÄ ÏïäÏùå.

-> ÏòàÏô∏Ï†ÅÏù∏ Í≤ΩÏö∞Î•º ÎåÄÎπÑÌïòÏó¨, ÏùëÎãµ ÏÜçÎèÑÎäî Ï°∞Í∏à ÎäêÎ¶¨ÎçîÎùºÎèÑ ÏÑúÎ≤ÑÍ∞Ä Ï£ΩÎäî Í≤ÉÎßåÏùÄ ÎßâÏïÑÎ≥¥Ïûê

512MBÎ°ú Ïò¨Î¶º. ÌîÑÎ°úÏÑ∏Ïä§Í∞Ä Ï£ΩÏñ¥Î≤ÑÎ¶º

// Ï†ÄÎÑêÏª®Ìä∏Î°§ Î™ÖÎ†πÏñ¥
// ÏãúÏä§ÌÖú Î°úÍ∑∏ ÏÇ¨ÏßÑ

OOM KillerÍ∞Ä JVM ÌîÑÎ°úÏÑ∏Ïä§Î•º Ï£ΩÏó¨Î≤ÑÎ¶∞ Í≤ÉÏùÑ ÌôïÏù∏

[OOM KillerÎäî Ïñ¥Îñ§ Î∞©ÏãùÏúºÎ°ú Ï£ΩÏùº ÌîÑÎ°úÏÑ∏Ïä§Î•º Ï∞æÎäîÏßÄÏóê ÎåÄÌï¥]

[Î¶¨ÎàÖÏä§ ÏãúÏä§ÌÖú Î°úÍ∑∏]

ÏùëÎãµ ÏãúÍ∞ÑÏù¥ ÏßÄÏó∞ÎêòÎçîÎùºÎèÑ ÏÑúÎ≤ÑÍ∞Ä Ï£ΩÎäî Í≤É ÎßâÏûê. Ïä§Î†àÎìú Ïàò Ï†úÌïú.


[Î©îÎ™®Î¶¨ Î∂ÑÏÑùÌïòÎäîÎ≤ï]

-XX:NativeMemoryTracking=summary

```

Native Memory Tracking:

Total: reserved=2082907KB +15KB, committed=448079KB +79KB

-                 Java Heap (reserved=524288KB, committed=262144KB)
                            (mmap: reserved=524288KB, committed=262144KB)

-                     Class (reserved=1118043KB, committed=77903KB)
                            (classes #14122)
                            (  instance classes #13293, array classes #829)
                            (malloc=1883KB #32845 +19)
                            (mmap: reserved=1116160KB, committed=76020KB)
                            (  Metadata:   )
                            (    reserved=67584KB, committed=66420KB)
                            (    used=65294KB +23KB)
                            (    free=1126KB -23KB)
                            (    waste=0KB =0.00%)
                            (  Class space:)
                            (    reserved=1048576KB, committed=9600KB)
                            (    used=8935KB)
                            (    free=665KB)
                            (    waste=0KB =0.00%)

-                    Thread (reserved=102637KB, committed=5125KB)
                            (thread #50)
                            (stack: reserved=102400KB, committed=4888KB)
                            (malloc=180KB #302)
                            (arena=58KB #99)

-                      Code (reserved=249109KB +9KB, committed=23805KB +73KB)
                            (malloc=1421KB +9KB #7255 +31)
                            (mmap: reserved=247688KB, committed=22384KB +64KB)

-                        GC (reserved=57974KB +1KB, committed=48246KB +1KB)
                            (malloc=5710KB +1KB #8969 +26)
                            (mmap: reserved=52264KB, committed=42536KB)

-                  Compiler (reserved=178KB, committed=178KB)
                            (malloc=45KB #517)
                            (arena=133KB #5)

-                  Internal (reserved=1039KB, committed=1039KB)
                            (malloc=1007KB #1909)
                            (mmap: reserved=32KB, committed=32KB)

-                     Other (reserved=8275KB, committed=8275KB)
                            (malloc=8275KB #17)

-                    Symbol (reserved=17138KB, committed=17138KB)
                            (malloc=14700KB #176682 +3)
                            (arena=2437KB #1)

-    Native Memory Tracking (reserved=3663KB +5KB, committed=3663KB +5KB)
                            (malloc=18KB +3KB #235 +50)
                            (tracking overhead=3645KB +2KB)

-               Arena Chunk (reserved=178KB, committed=178KB)
                            (malloc=178KB)

-                   Logging (reserved=4KB, committed=4KB)
                            (malloc=4KB #188)

-                 Arguments (reserved=19KB, committed=19KB)
                            (malloc=19KB #497)

-                    Module (reserved=194KB, committed=194KB)
                            (malloc=194KB #2312)

-              Synchronizer (reserved=162KB, committed=162KB)
                            (malloc=162KB #1363)

-                 Safepoint (reserved=8KB, committed=8KB)
                            (mmap: reserved=8KB, committed=8KB)

```





[Ï°∞Í∏à Îçî ÌäúÎãù]

jcmd Î™ÖÎ†πÏúºÎ°ú Í∞ÄÏÉÅÎ®∏Ïã† Î©îÎ™®Î¶¨ ÏÇ¨Ïö©Îüâ ÌôïÏù∏ Í∞ÄÎä•

> jcmd {PID} VM.native_memory baseline
> jcmd {PID} VM.native_memory summary.diff



sudo jstat -gccapacity 17692
```
NGCMN    NGCMX     NGC     S0C   S1C       EC      OGCMN      OGCMX       OGC         OC       MCMN     MCMX      MC     CCSMN    CCSMX     CCSC    YGC    FGC   CGC
     0.0 262144.0 157696.0    0.0 1024.0 156672.0        0.0   262144.0   104448.0   104448.0      0.0 1124352.0  86128.0      0.0 1048576.0  10536.0    958   140   519
```


```
ubuntu@ip-192-168-1-212:~$ sudo jstat -gc 17692 1000
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT
 0.0   1024.0  0.0   1024.0 156672.0 26624.0   104448.0   89281.0   86128.0 83693.6 10536.0 9725.2    958    5.534  140    18.955  519     7.467   31.956
 0.0   1024.0  0.0   1024.0 156672.0 26624.0   104448.0   89281.0   86128.0 83693.6 10536.0 9725.2    958    5.534  140    18.955  519     7.467   31.956
 0.0   1024.0  0.0   1024.0 156672.0 26624.0   104448.0   89281.0   86128.0 83693.6 10536.0 9725.2    958    5.534  140    18.955  519     7.467   31.956
 0.0   1024.0  0.0   1024.0 156672.0 26624.0   104448.0   89281.0   86128.0 83693.6 10536.0 9725.2    958    5.534  140    18.955  519     7.467   31.956
 0.0   1024.0  0.0   1024.0 156672.0 26624.0   104448.0   89281.0   86128.0 83693.6 10536.0 9725.2    958    5.534  140    18.955  519     7.467   31.956
 0.0   1024.0  0.0   1024.0 156672.0 26624.0   104448.0   89281.0   86128.0 83693.6 10536.0 9725.2    958    5.534  140    18.955  519     7.467   31.956
 0.0   1024.0  0.0   1024.0 156672.0 26624.0   104448.0   89281.0   86128.0 83693.6 10536.0 9725.2    958    5.534  140    18.955  519     7.467   31.956
 0.0   1024.0  0.0   1024.0 156672.0 26624.0   104448.0   89281.0   86128.0 83693.6 10536.0 9725.2    958    5.534  140    18.955  519     7.467   31.956
 0.0   1024.0  0.0   1024.0 156672.0 26624.0   104448.0   89281.0   86128.0 83693.6 10536.0 9725.2    958    5.534  140    18.955  519     7.467   31.956
 0.0   1024.0  0.0   1024.0 156672.0 26624.0   104448.0   89281.0   86128.0 83693.6 10536.0 9725.2    958    5.534  140    18.955  519     7.467   31.956
 0.0   1024.0  0.0   1024.0 156672.0 26624.0   104448.0   89281.0   86128.0 83693.6 10536.0 9725.2    958    5.534  140    18.955  519     7.467   31.956
 0.0   1024.0  0.0   1024.0 156672.0 26624.0   104448.0   89281.0   86128.0 83693.6 10536.0 9725.2    958    5.534  140    18.955  519     7.467   31.956
```



young ÏòÅÏó≠Í≥º old ÏòÅÏó≠. Í∞ùÏ≤¥Ïùò ÌäπÏÑ±
NewRatio=4

```
ubuntu@ip-192-168-1-212:~$ sudo jstat -gc 17978 1000
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT
 0.0   7168.0  0.0   7168.0 48128.0  20480.0   206848.0   51078.3   86004.0 83678.3 10572.0 9718.6    877    4.902  220    21.972  595     8.433   35.308
 0.0   7168.0  0.0   7168.0 48128.0  20480.0   206848.0   51078.3   86004.0 83678.3 10572.0 9718.6    877    4.902  220    21.972  595     8.433   35.308
 0.0   7168.0  0.0   7168.0 48128.0  20480.0   206848.0   51078.3   86004.0 83678.3 10572.0 9718.6    877    4.902  220    21.972  595     8.433   35.308
 0.0   7168.0  0.0   7168.0 48128.0  20480.0   206848.0   51078.3   86004.0 83678.3 10572.0 9718.6    877    4.902  220    21.972  595     8.433   35.308
 0.0   7168.0  0.0   7168.0 48128.0  20480.0   206848.0   51078.3   86004.0 83678.3 10572.0 9718.6    877    4.902  220    21.972  595     8.433   35.308
 0.0   7168.0  0.0   7168.0 48128.0  20480.0   206848.0   51078.3   86004.0 83678.3 10572.0 9718.6    877    4.902  220    21.972  595     8.433   35.308

```






